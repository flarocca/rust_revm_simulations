use crate::commands::uniswap_v3::contracts::Pool;
use crate::commands::Command;
use crate::commons::erc20::Erc20;
use crate::commons::helpers::{set_eth_balance, AlloyCacheDB};
use alloy_eips::{BlockId, BlockNumberOrTag};
use alloy_provider::Provider;
use alloy_provider::{ProviderBuilder, RootProvider};
use alloy_rpc_types::Block;
use alloy_transport_http::Http;
use anyhow::Result;
use async_trait::async_trait;
use clap::{Arg, ArgAction, ArgMatches};
use lazy_static::lazy_static;
use reqwest::Client;
use revm::db::{AlloyDB, CacheDB};
use revm::primitives::{address, bytes, Address, Bytecode, U256};
use std::str::FromStr;

lazy_static! {
    pub static ref UNISWAP_V3_SIMULATOR_CODE: Bytecode =
        Bytecode::new_raw(bytes!("608060405234801561001057600080fd5b506004361061004c5760003560e01c806310d1e85c146100515780635b45d91b14610066578063a4d2f3331461008c578063fa461e33146100ac575b600080fd5b61006461005f36600461185b565b6100bf565b005b610079610074366004611b55565b610329565b6040519081526020015b60405180910390f35b61009f61009a366004611b55565b610474565b6040516100839190611c98565b6100646100ba366004611ce1565b610589565b60006100cd82840184611d33565b60608101516040516370a0823160e01b81523060048201529192506000916001600160a01b03909116906370a0823190602401602060405180830381865afa15801561011d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101419190611dea565b905060008260200151826101559190611e19565b905061016183826108ad565b7f10f444a4e422e18edb78ecdae69db2d32f421aff4b21f517451ced274ddd5abc3384606001518560200151856101989190611e19565b604087810151885182516001600160a01b03968716815294861660208601528483019390935260608401529216608082015260a081018a905260c0810189905290519081900360e00190a182516040516370a0823160e01b81523060048201526000916001600160a01b0316906370a0823190602401602060405180830381865afa15801561022b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061024f9190611dea565b905080846040015111156102a3577f69cd223c09c2fc3f53d31cf5f598dc5716791fd92414af9dc3cf286dbd66ff9884600001513383876040015160405161029a9493929190611e30565b60405180910390a15b8351604080860151905163a9059cbb60e01b815233600482015260248101919091526001600160a01b039091169063a9059cbb906044016020604051808303816000875af11580156102f9573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061031d9190611e59565b50505050505050505050565b6000806103358361097f565b6040516370a0823160e01b81523060048201529091506000906001600160a01b038316906370a0823190602401602060405180830381865afa15801561037f573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103a39190611dea565b90506103ae84610a02565b6040516370a0823160e01b81523060048201526000906001600160a01b038416906370a0823190602401602060405180830381865afa1580156103f5573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906104199190611dea565b90507f54e7c213825c4ce21fff82717321634dde01833ee7d1d29370e2523541b298a0836104478484611e19565b604080516001600160a01b03909316835260208301919091520160405180910390a1506001949350505050565b606060018251111561054f576001825161048e9190611e19565b6001600160401b038111156104a5576104a56118c2565b6040519080825280602002602001820160405280156104de57816020015b6104cb611779565b8152602001906001900390816104c35790505b50905060015b825181101561054957600083828151811061050157610501611e7d565b60200260200101519050808360018461051a9190611e19565b8151811061052a5761052a611e7d565b602002602001018190525050808061054190611e93565b9150506104e4565b50919050565b6040805160008082526020820190925290610580565b61056d611779565b8152602001906001900390816105655790505b5090505b919050565b600061059782840184611d33565b60608101516040516370a0823160e01b81523060048201529192506000916001600160a01b03909116906370a0823190602401602060405180830381865afa1580156105e7573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061060b9190611dea565b9050600082602001518261061f9190611e19565b905061062b83826108ad565b7fe1c929aac14e1e07956b76884bdf8b0ac7208266470ae5b723664d57d9cc661e3384606001518560200151856106629190611e19565b8651604080516001600160a01b03958616815293851660208501528301919091529190911660608201526080810189905260a0810188905260c00160405180910390a182516040516370a0823160e01b81523060048201526000916001600160a01b0316906370a0823190602401602060405180830381865afa1580156106ed573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107119190611dea565b905060008813156107dd57808811156107635783516040517f69cd223c09c2fc3f53d31cf5f598dc5716791fd92414af9dc3cf286dbd66ff989161075a91339085908d90611e30565b60405180910390a15b835160405163a9059cbb60e01b8152336004820152602481018a90526001600160a01b039091169063a9059cbb906044016020604051808303816000875af11580156107b3573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906107d79190611e59565b506108a3565b60008713156108a3578087111561082d5783516040517f69cd223c09c2fc3f53d31cf5f598dc5716791fd92414af9dc3cf286dbd66ff989161082491339085908c90611e30565b60405180910390a15b835160405163a9059cbb60e01b8152336004820152602481018990526001600160a01b039091169063a9059cbb906044016020604051808303816000875af115801561087d573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906108a19190611e59565b505b5050505050505050565b60a0820151511561097b578160a001516000815181106108cf576108cf611e7d565b6020026020010151602001516060015160000361091357808260a001516000815181106108fe576108fe611e7d565b60200260200101516020015160600181815250505b8160a0015160008151811061092a5761092a611e7d565b60200260200101516040015160a0015160000361096e57808260a0015160008151811061095957610959611e7d565b60200260200101516040015160a00181815250505b61097b8260a00151610a02565b5050565b6000808260008151811061099557610995611e7d565b60200260200101519050600060018111156109b2576109b2611b89565b815160018111156109c5576109c5611b89565b036109da578060200151602001519150610549565b6001815160018111156109ef576109ef611b89565b0361054957604090810151015192915050565b60008082600081518110610a1857610a18611e7d565b60200260200101519050600083511115610a895782600081518110610a3f57610a3f611e7d565b6020026020010151905060006001811115610a5c57610a5c611b89565b81516001811115610a6f57610a6f611b89565b03610a8e578060200151606001519150610a898383610abd565b505050565b600181516001811115610aa357610aa3611b89565b03610a8957806040015160a001519150610a898383610c2b565b61097b82600081518110610ad357610ad3611e7d565b6020026020010151602001516000015183600081518110610af657610af6611e7d565b6020026020010151602001516020015184600081518110610b1957610b19611e7d565b602002602001015160200151604001518486600081518110610b3d57610b3d611e7d565b60200260200101516020015160c0015187600081518110610b6057610b60611e7d565b60200260200101516020015160e001516000610c078a8b600081518110610b8957610b89611e7d565b602002602001015160400151600001518c600081518110610bac57610bac611e7d565b602002602001015160200151602001518d600081518110610bcf57610bcf611e7d565b602002602001015160200151606001518e600081518110610bf257610bf2611e7d565b60200260200101516020015160400151610d97565b604051602001610c179190611eac565b604051602081830303815290604052610ea7565b61097b82600081518110610c4157610c41611e7d565b6020026020010151604001516000015183600081518110610c6457610c64611e7d565b6020026020010151604001516020015184600081518110610c8757610c87611e7d565b6020026020010151604001516040015185600081518110610caa57610caa611e7d565b6020026020010151604001516060015186600081518110610ccd57610ccd611e7d565b6020026020010151604001516080015186610d73898a600081518110610cf557610cf5611e7d565b602002602001015160400151600001518b600081518110610d1857610d18611e7d565b602002602001015160400151604001518c600081518110610d3b57610d3b611e7d565b60200260200101516040015160a001518d600081518110610d5e57610d5e611e7d565b60200260200101516040015160600151610d97565b604051602001610d839190611eac565b604051602081830303815290604052610ede565b610deb6040518060c0016040528060006001600160a01b03168152602001600081526020016000815260200160006001600160a01b0316815260200160006001600160a01b03168152602001606081525090565b6040805160c0810182526001600160a01b03808716825291516370a0823160e01b815230600482015290916020830191908516906370a0823190602401602060405180830381865afa158015610e45573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610e699190611dea565b8152602001848152602001836001600160a01b03168152602001866001600160a01b03168152602001610e9b88610474565b90529695505050505050565b6000610eb38888610eef565b509050610ed1898983610eca8d8d8d888e8e610feb565b88876110ae565b5050505050505050505050565b600080610ed1888a8988888861114b565b600080826001600160a01b0316846001600160a01b031603610f665760405162461bcd60e51b815260206004820152602560248201527f556e697377617056324c6962726172793a204944454e544943414c5f41444452604482015264455353455360d81b60648201526084015b60405180910390fd5b826001600160a01b0316846001600160a01b031610610f86578284610f89565b83835b90925090506001600160a01b038216610fe45760405162461bcd60e51b815260206004820152601e60248201527f556e697377617056324c6962726172793a205a45524f5f4144445245535300006044820152606401610f5d565b9250929050565b6000806000886001600160a01b0316630902f1ac6040518163ffffffff1660e01b8152600401606060405180830381865afa15801561102e573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906110529190611f5b565b506001600160701b031691506001600160701b03169150600080876001600160a01b03168a6001600160a01b03161461108c57828461108f565b83835b9150915061109f878383896112c6565b9b9a5050505050505050505050565b600080856001600160a01b0316876001600160a01b0316036110d5575060009050836110dc565b5083905060005b60405163022c0d9f60e01b81526001600160a01b0389169063022c0d9f9061110e908590859089908990600401612007565b600060405180830381600087803b15801561112857600080fd5b505af115801561113c573d6000803e3d6000fd5b50505050965096945050505050565b600080866001600160a01b031663128acb088987878961118957611184600173fffd8963efd1fc6a506488495d951d5263988d2661203e565b611199565b6111996401000276a36001612066565b886040518663ffffffff1660e01b81526004016111ba959493929190612091565b60408051808303816000875af19250505080156111f4575060408051601f3d908101601f191682019092526111f1918101906120d7565b60015b6112b7576112006120fb565b806308c379a0036112745750611214612117565b8061121f5750611276565b80611229896113f0565b611232896113f0565b61123b88611582565b60405160200161124e94939291906121a0565b60408051601f198184030181529082905262461bcd60e51b8252610f5d9160040161221a565b505b3d8080156112a0576040519150601f19603f3d011682016040523d82523d6000602084013e6112a5565b606091505b508060405160200161124e919061222d565b90999098509650505050505050565b600080851161132b5760405162461bcd60e51b815260206004820152602b60248201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4960448201526a1394155517d05353d5539560aa1b6064820152608401610f5d565b60008411801561133b5750600083115b6113985760405162461bcd60e51b815260206004820152602860248201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4c604482015267495155494449545960c01b6064820152608401610f5d565b60006113b06113a9846103e8611e19565b879061168a565b905060006113be828661168a565b905060006113d8836113d2896103e861168a565b906116f7565b90506113e4818361227e565b98975050505050505050565b604051606082811b6bffffffffffffffffffffffff191660208301529060009060340160408051808303601f19018152602a80845260608401909252925060009190602082018180368337019050509050600360fc1b8160008151811061145957611459611e7d565b60200101906001600160f81b031916908160001a905350600f60fb1b8160018151811061148857611488611e7d565b60200101906001600160f81b031916908160001a90535060005b601481101561157a5760008382815181106114bf576114bf611e7d565b016020015160f81c90506114dc6114d7601083612292565b61174c565b836114e88460026122b4565b6114f39060026122d3565b8151811061150357611503611e7d565b60200101906001600160f81b031916908160001a9053506115286114d76010836122eb565b836115348460026122b4565b61153f9060036122d3565b8151811061154f5761154f611e7d565b60200101906001600160f81b031916908160001a90535050808061157290611e93565b9150506114a2565b509392505050565b6060816000036115a95750506040805180820190915260018152600360fc1b602082015290565b8160005b81156115d357806115bd81611e93565b91506115cc9050600a8361227e565b91506115ad565b6000816001600160401b038111156115ed576115ed6118c2565b6040519080825280601f01601f191660200182016040528015611617576020820181803683370190505b5090505b84156116825761162c600183611e19565b9150611639600a8661230d565b6116449060306122d3565b60f81b81838151811061165957611659611e7d565b60200101906001600160f81b031916908160001a90535061167b600a8661227e565b945061161b565b949350505050565b60008115806116ae575082826116a081836122b4565b92506116ac908361227e565b145b6116f15760405162461bcd60e51b815260206004820152601460248201527364732d6d6174682d6d756c2d6f766572666c6f7760601b6044820152606401610f5d565b92915050565b60008261170483826122d3565b91508110156116f15760405162461bcd60e51b815260206004820152601460248201527364732d6d6174682d6164642d6f766572666c6f7760601b6044820152606401610f5d565b6000600a8260ff16101561176e57611765826030612321565b60f81b92915050565b611765826057612321565b60408051606081019091528060008152604080516101008101825260008082526020828101829052928201819052606082018190526080820181905260a0820181905260c0820181905260e082015291019081526040805160c08101825260008082526020828101829052928201819052606082018190526080820181905260a082015291015290565b80356001600160a01b038116811461058457600080fd5b60008083601f84011261182c57600080fd5b5081356001600160401b0381111561184357600080fd5b602083019150836020828501011115610fe457600080fd5b60008060008060006080868803121561187357600080fd5b61187c86611803565b9450602086013593506040860135925060608601356001600160401b038111156118a557600080fd5b6118b18882890161181a565b969995985093965092949392505050565b634e487b7160e01b600052604160045260246000fd5b60c081018181106001600160401b03821117156118f7576118f76118c2565b60405250565b606081018181106001600160401b03821117156118f7576118f76118c2565b61010081018181106001600160401b03821117156118f7576118f76118c2565b601f8201601f191681016001600160401b0381118282101715611961576119616118c2565b6040525050565b801515811461197657600080fd5b50565b600060c0828403121561198b57600080fd5b604051611997816118d8565b8091506119a383611803565b81526119b160208401611803565b60208201526119c260408401611803565b60408201526119d360608401611803565b606082015260808301356119e681611968565b608082015260a092830135920191909152919050565b600082601f830112611a0d57600080fd5b813560206001600160401b03821115611a2857611a286118c2565b60408051611a3b838560051b018261193c565b8381526101e093840286018301938382019088861115611a5a57600080fd5b8488015b86811015611b4757808a0382811215611a775760008081fd5b8551611a82816118fd565b823560028110611a925760008081fd5b8152610100601f198301811315611aa95760008081fd5b87519250611ab68361191c565b611ac1898501611803565b8352611ace888501611803565b898401526060611adf818601611803565b898501526080808601358286015260a0915081860135818601525060c0808601358286015260e09150818601358186015250611b1c828601611803565b8185015250508188820152611b358c6101208501611979565b81880152845250918501918101611a5e565b509198975050505050505050565b600060208284031215611b6757600080fd5b81356001600160401b03811115611b7d57600080fd5b611682848285016119fc565b634e487b7160e01b600052602160045260246000fd5b6000815160028110611bc157634e487b7160e01b600052602160045260246000fd5b80845250602082015160018060a01b038082511660208601528060208301511660408601528060408301511660608601525060608101516080850152608081015160a085015260a081015160c085015260c081015160e085015260e08101519050611c386101008501826001600160a01b03169052565b505060409081015180516001600160a01b03908116610120850152602082015181166101408501529181015182166101608401526060810151909116610180830152608081015115156101a083015260a001516101c08201526101e00190565b6020808252825182820181905260009190848201906040850190845b81811015611cd557611cc7838551611b9f565b938501939250600101611cb4565b50909695505050505050565b60008060008060608587031215611cf757600080fd5b843593506020850135925060408501356001600160401b03811115611d1b57600080fd5b611d278782880161181a565b95989497509550505050565b600060208284031215611d4557600080fd5b81356001600160401b0380821115611d5c57600080fd5b9083019060c08286031215611d7057600080fd5b604051611d7c816118d8565b611d8583611803565b81526020830135602082015260408301356040820152611da760608401611803565b6060820152611db860808401611803565b608082015260a083013582811115611dcf57600080fd5b611ddb878286016119fc565b60a08301525095945050505050565b600060208284031215611dfc57600080fd5b5051919050565b634e487b7160e01b600052601160045260246000fd5b600082821015611e2b57611e2b611e03565b500390565b6001600160a01b0394851681529290931660208301526040820152606081019190915260800190565b600060208284031215611e6b57600080fd5b8151611e7681611968565b9392505050565b634e487b7160e01b600052603260045260246000fd5b600060018201611ea557611ea5611e03565b5060010190565b6000602080835260e0830160018060a01b038086511683860152828601516040860152604086015160608601528060608701511660808601528060808701511660a08601525060a085015160c080860152818151808452610100870191508483019350600092505b80831015611f3957611f27828551611b9f565b91508484019350600183019250611f14565b509695505050505050565b80516001600160701b038116811461058457600080fd5b600080600060608486031215611f7057600080fd5b611f7984611f44565b9250611f8760208501611f44565b9150604084015163ffffffff81168114611fa057600080fd5b809150509250925092565b60005b83811015611fc6578181015183820152602001611fae565b83811115611fd5576000848401525b50505050565b60008151808452611ff3816020860160208601611fab565b601f01601f19169290920160200192915050565b84815283602082015260018060a01b03831660408201526080606082015260006120346080830184611fdb565b9695505050505050565b60006001600160a01b038381169083168181101561205e5761205e611e03565b039392505050565b60006001600160a01b0382811684821680830382111561208857612088611e03565b01949350505050565b6001600160a01b0386811682528515156020830152604082018590528316606082015260a0608082018190526000906120cc90830184611fdb565b979650505050505050565b600080604083850312156120ea57600080fd5b505080516020909101519092909150565b600060033d11156121145760046000803e5060005160e01c5b90565b600060443d10156121255790565b6040516003193d81016004833e81513d6001600160401b03816024840111818411171561215457505050505090565b828501915081518181111561216c5750505050505090565b843d87010160208285010111156121865750505050505090565b6121956020828601018761193c565b509095945050505050565b600085516121b2818460208a01611fab565b80830190506201016960ed1b80825286516121d4816003850160208b01611fab565b6003920191820181905285516121f1816006850160208a01611fab565b6006920191820152835161220c816009840160208801611fab565b016009019695505050505050565b602081526000611e766020830184611fdb565b7202aa724a9aba0a82fab19902932bb32b93a1d1606d1b81526000825161225b816013850160208701611fab565b9190910160130192915050565b634e487b7160e01b600052601260045260246000fd5b60008261228d5761228d612268565b500490565b600060ff8316806122a5576122a5612268565b8060ff84160491505092915050565b60008160001904831182151516156122ce576122ce611e03565b500290565b600082198211156122e6576122e6611e03565b500190565b600060ff8316806122fe576122fe612268565b8060ff84160691505092915050565b60008261231c5761231c612268565b500690565b600060ff821660ff84168060ff0382111561233e5761233e611e03565b01939250505056fea26469706673582212201c513b43dfb731d50c688c68b3cf1a7afe72c49f066d824964d3c5bd3906a0e664736f6c634300080f0033"));

}

#[derive(Debug, Clone)]
pub(crate) struct SwapViaPoolConfig {
    pool: Address,
    token_in: Address,
    amount: U256,
    caller: Address,
}

impl SwapViaPoolConfig {
    pub fn from_args(caller: Address, args: &ArgMatches) -> Self {
        let pool = args
            .get_one::<String>("pool")
            .expect("Pool address is required");
        let pool = Address::from_str(pool).expect("Invalid pool in address");

        let token_in = args
            .get_one::<String>("token-in")
            .expect("Token in is required");
        let token_in = Address::from_str(token_in).expect("Invalid token in address");

        let amount = args
            .get_one::<String>("amount")
            .expect("Amount is required");
        let amount = U256::from_str(amount).expect("Invalid amount");

        Self {
            pool,
            token_in,
            amount,
            caller,
        }
    }
}

pub struct SwapViaPool;

impl SwapViaPool {
    fn deploy_simulator(&self, database: &mut AlloyCacheDB) -> Result<Address> {
        let simulator_address = address!("000000000abcd55555000055555dcba000000000");

        database.Ok(simulator_address)
    }

    fn simulate(
        &self,
        block: &Block,
        client: &RootProvider<Http<Client>>,
        swap_configuration: &SwapViaPoolConfig,
    ) -> Result<(U256, U256)> {
        let block_id = BlockId::Number(BlockNumberOrTag::Number(block.header.number));
        let mut database = CacheDB::new(AlloyDB::new(client, block_id).unwrap());

        let pool = Pool::new(swap_configuration.caller, swap_configuration.pool);
        let pool_data = pool.get_pool_data(&mut database)?;

        let token_out = if pool_data.token_0 == swap_configuration.token_in {
            pool_data.token_1
        } else {
            pool_data.token_0
        };

        let token_in = Erc20::new(swap_configuration.caller, swap_configuration.token_in);
        let token_out = Erc20::new(swap_configuration.caller, token_out);

        // Optional step for convenience. Extreme caution is advised when using this method
        // as this might lead to a simulation that does not match the real state of the blockchain.
        set_eth_balance(
            swap_configuration.caller,
            swap_configuration.amount,
            &mut database,
        );
        let _ = token_in.set_balance(
            swap_configuration.caller,
            swap_configuration.amount,
            &mut database,
        );

        // Save the balances before perdorming the swap so that we can validate that the swap
        // was successful.
        let balance_in_before = token_in
            .balance_of(swap_configuration.caller, &mut database)?
            .0;
        let balance_out_before = token_out
            .balance_of(swap_configuration.caller, &mut database)?
            .0;

        let (amount0_out, amount1_out) =
            self.get_output_amounts(swap_configuration, &mut database)?;

        // Mandatory step, before executing the swap on the pool we need to transfer the correct input
        // token amount to the pool. Without this step, the swap will fail with a `ISUFFICIENT
        // LIQUIDITY` error.
        let _ = token_in.transfer(
            swap_configuration.pool,
            swap_configuration.amount,
            &mut database,
        )?;

        let _ = pool.swap(
            amount0_out,
            amount1_out,
            swap_configuration.caller,
            &mut database,
        )?;

        // In order to ensure the swap was successful, we need to check the balances of both tokens
        // before and after the swap.
        let balance_in_after = token_in
            .balance_of(swap_configuration.caller, &mut database)?
            .0;
        let balance_out_after = token_out
            .balance_of(swap_configuration.caller, &mut database)?
            .0;

        let amount_out = if pool_data.token_0 == swap_configuration.token_in {
            amount1_out
        } else {
            amount0_out
        };

        assert!(
            balance_in_before - swap_configuration.amount == balance_in_after,
            "The balance of token in does not match the expected output"
        );
        assert!(
            balance_out_before + amount_out == balance_out_after,
            "The balance of token out does not match the expected output"
        );

        // TODO: For now we are just returning the input and output amounts, which is fine and works.
        // However, that means we will have to build the transaction again to send it to builders.
        // An alternative approach would be to build the final transaction, simulate it and if ok
        // return the transaction ready to be sent.
        Ok((swap_configuration.amount, amount_out))
    }

    fn get_output_amounts(
        &self,
        swap_configuration: &SwapViaPoolConfig,
        database: &mut AlloyCacheDB,
    ) -> Result<(U256, U256)> {
        // In UniswapV2 protocol, the fee is harcoded to be 0.3%. Since pools are deployed via a
        // well-known factory (0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f) also known as Uniswap V2 Deployer,
        // we can safely assume the fee is always 0.3%.
        // Ideally, we should always validate the factory that deployed the pool, not only to ensure
        // the fee is correct, but also to be sure the pool is not a malicious one.
        //
        // For more information check the contract code at: https://github.com/Uniswap/v2-periphery/blob/0335e8f7e1bd1e8d8329fd300aea2ef2f36dd19f/contracts/libraries/UniswapV2Library.sol#L43
        let fee = U256::from(3);
        let percentage = U256::from(1000);

        let pool = Pool::new(swap_configuration.caller, swap_configuration.pool);

        let (reserve_0, reserve_1) = pool.get_reserves(database)?;
        let pool_data = pool.get_pool_data(database)?;

        let (reserve_input, reserver_output) = if pool_data.token_0 == swap_configuration.token_in {
            (reserve_0, reserve_1)
        } else {
            (reserve_1, reserve_0)
        };

        let amount_in_with_fee = swap_configuration
            .amount
            .saturating_mul(percentage.saturating_sub(fee)); // Amoun * (1000 - fee)
        let numerator = amount_in_with_fee.saturating_mul(reserver_output);
        let denominator = reserve_input
            .saturating_mul(percentage)
            .saturating_add(amount_in_with_fee);

        let amount_out = numerator.checked_div(denominator).unwrap();

        if pool_data.token_0 == swap_configuration.token_in {
            Ok((U256::ZERO, amount_out))
        } else {
            Ok((amount_out, U256::ZERO))
        }
    }
}

#[async_trait]
impl Command for SwapViaPool {
    fn create(&self) -> clap::Command {
        clap::Command::new("swap-via-pool-v3")
            .about("Swap tokens via the Uniswap V3 Pool")
            .long_flag("swap-via-pool-v3")
            .arg(
                Arg::new("rpc-url")
                    .long("rpc-url")
                    .action(ArgAction::Set)
                    .required(true)
                    .help("The RPC URL to connect to"),
            )
            .arg(
                Arg::new("token-in")
                    .long("token-in")
                    .help("The token to swap from")
                    .required(true)
                    .action(ArgAction::Set),
            )
            .arg(
                Arg::new("pool")
                    .long("pool")
                    .help("The pool address")
                    .required(true)
                    .action(ArgAction::Set),
            )
            .arg(
                Arg::new("amount")
                    .long("amount")
                    .help("The amount of token in to swap")
                    .required(true)
                    .action(ArgAction::Set),
            )
    }

    fn name(&self) -> String {
        "swap-via-pool-v3".to_owned()
    }

    async fn execute(&self, args: &ArgMatches) {
        let rpc_url = args
            .get_one::<String>("rpc-url")
            .expect("RPC URL is required");
        let rpc_url = rpc_url.parse().unwrap();

        let client = ProviderBuilder::new().on_http(rpc_url);
        let block = client
            .get_block_by_number(BlockNumberOrTag::Latest, true)
            .await
            .unwrap()
            .unwrap();

        // The caller must be the public address that will sign the transactions,
        // which implies this wallet must be funded. For the purposes of this example
        // we are using a random address that is funded when simulating.
        let caller = address!("FF3cF7b8582571095A2B05268A4E1BafBDAD060D");

        let swap_configuration = SwapViaPoolConfig::from_args(caller, args);

        // Step 1: Based on the discovery made with the router, we know simulate the swap hitting
        // the poool straight away.
        let result = self
            .simulate(&block, &client, &swap_configuration)
            .expect("Error running simulation for pool");

        println!("Swap Via Pool - Result: \n{:#?}", result);

        // Step 3: Build the final transaction and send it to builders.
        // Step 4: Monitor the chain until we find our transaction in a block
        // WIP
    }
}
